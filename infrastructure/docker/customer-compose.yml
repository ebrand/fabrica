# Fabrica Commerce Cloud - Customer Domain Services
# Handles customer accounts, profiles, addresses, and segments

services:
  # Customer Domain Database Initializer
  # Creates the fabrica-customer-db database with required schemas
  customer-db-init:
    image: postgres:16-alpine
    container_name: customer-db-init
    environment:
      PGHOST: postgres
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER:-fabrica_admin}
      PGPASSWORD: ${POSTGRES_PASSWORD:-fabrica_dev_password}
    networks:
      - fabrica-network
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ../../domain/customer/database/init:/docker-entrypoint-initdb.d:ro
    entrypoint: >
      sh -c "
        echo 'Initializing Customer domain database...' &&
        psql -d postgres -c 'CREATE DATABASE \"fabrica-customer-db\";' 2>/dev/null || echo 'Database already exists' &&
        echo 'Creating schemas...' &&
        psql -d fabrica-customer-db -c 'CREATE SCHEMA IF NOT EXISTS fabrica;' &&
        psql -d fabrica-customer-db -c 'CREATE SCHEMA IF NOT EXISTS cdc;' &&
        echo 'Running initialization scripts...' &&
        for f in /docker-entrypoint-initdb.d/*.sql; do
          if [ -f \"$$f\" ]; then
            echo \"Executing $$f...\" &&
            psql -d fabrica-customer-db -f \"$$f\" || echo \"Failed to execute $$f\"
          fi
        done &&
        echo 'Customer database initialized successfully'
      "
    restart: "no"

  # Customer Domain Service (ACL)
  # Handles customer CRUD, addresses, and segment management
  # Port 3410 per PORTS.md (Customer API)
  acl-customer:
    build:
      context: ../../domain
      dockerfile: customer/acl/CustomerDomainService/Dockerfile
    container_name: acl-customer
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ASPNETCORE_URLS=http://+:3410
      # Only AdminACL URL - all other config fetched via service discovery
      - AclAdmin__Url=http://acl-admin:3600
    ports:
      - "3410:3410"
    networks:
      - fabrica-network
    depends_on:
      acl-admin:
        condition: service_healthy
      customer-db-init:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      consul:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3410/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# Network is inherited from the master fabrica-compose.yml file
